version: '3.8'

services:
  oidc_db:
    image: postgres:15-alpine
    container_name: financetracking_identity_db
    environment:
      POSTGRES_USER: ${IDENTITY_DB_USER}
      POSTGRES_PASSWORD: ${IDENTITY_DB_PASSWORD}
      POSTGRES_DB: ${IDENTITY_DB_NAME}
    ports:
      - "${IDENTITY_DB_HOST_PORT}:5432"
    volumes:
      - oidc_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${IDENTITY_DB_USER} -d ${IDENTITY_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  api_db:
    image: postgres:15-alpine
    container_name: financetracking_api_db
    environment:
      POSTGRES_USER: ${API_DB_USER}
      POSTGRES_PASSWORD: ${API_DB_PASSWORD}
      POSTGRES_DB: ${API_DB_NAME}
    ports:
      - "${API_DB_HOST_PORT}:5432"
    volumes:
      - api_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${API_DB_USER} -d ${API_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq_message_broker
    restart: always
    ports:
      - "${RABBITMQ_MICROSERVICES_CONNECTION_PORT}:5672" # The standard port for microservices to connect
      - "${RABBITMQ_MANAGEMENT_CONNECTION_PORT}:15672" # The web management UI port
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  oidc_server:
    build: 
      context: .
      dockerfile: ./backend/OidcServer/Dockerfile
    container_name: financetracking_oidc
    environment:
      - ConnectionStrings__DefaultConnection=Host=oidc_db;Port=5432;Database=${IDENTITY_DB_NAME};Username=${IDENTITY_DB_USER};Password=${IDENTITY_DB_PASSWORD}
      
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:8081
      - ASPNETCORE_Kestrel__Certificates__Default__Password=password
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/identityserver.pfx

      - IdentitySettings__FrontendUrl=${FRONTEND_URL}
      - IdentitySettings__CallbackPath=${OIDC_CALLBACK_PATH}

      - RabbitMq__Host=rabbitmq
      - RabbitMq__Username=${RABBITMQ_USERNAME}
      - RabbitMq__Password=${RABBITMQ_PASSWORD}

      - ApiSettings__ApiResourceName=${API_RESOURCE_NAME}
      - ApiSettings__BaseUrl=http://api_server:8080

      - OidcClients__Nuxt__ClientId=nuxt-client
      - OidcClients__Nuxt__DisplayName=Nuxt Frontend
      - OidcClients__Nuxt__RedirectUri=${FRONTEND_URL}${OIDC_CALLBACK_PATH} 
      - OidcClients__Nuxt__PostLogoutRedirectUri=${FRONTEND_URL}
    ports:
      - "${IDENTITY_SERVER_HOST_PORT}:8081"
    volumes:
      - ./backend/https/identityserver.pfx:/https/identityserver.pfx:ro
    depends_on:
      rabbitmq:
        condition: service_started
      oidc_db:
        condition: service_healthy

  api_server:
    build: 
      context: .
      dockerfile: ./backend/FinanceTracking.API/Dockerfile
    container_name: financetracking_api
    environment:
      - ConnectionStrings__DefaultConnection=Host=api_db;Port=5432;Database=${API_DB_NAME};Username=${API_DB_USER};Password=${API_DB_PASSWORD}

      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080

      - RabbitMq__Host=rabbitmq
      - RabbitMq__Username=${RABBITMQ_USERNAME}
      - RabbitMq__Password=${RABBITMQ_PASSWORD}

      - Authentication__Authority=https://oidc_server:8081
      - Authentication__ValidIssuer=${IDENTITY_SERVER_URL}
      - Authentication__Audience=${API_RESOURCE_NAME}
    ports:
      - "${API_SERVER_HOST_PORT}:8080"
    depends_on:
      api_db:
        condition: service_healthy
      rabbitmq:
        condition: service_started
      oidc_server:
        condition: service_started

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: financetracking_frontend
    extra_hosts:
      - "localhost:host-gateway"
    environment:
      - NODE_ENV=${NODE_ENV}
      - NUXT_HOST=${NUXT_HOST}
      - NUXT_PORT=${NUXT_PORT}
      - NODE_TLS_REJECT_UNAUTHORIZED=${NODE_TLS_REJECT_UNAUTHORIZED}
      
      - NUXT_API_SECRET=${PRIVATE_API_KEY}
      - NUXT_PUBLIC_API_BASE=${API_SERVER_URL}

      - NUXT_OIDC_PROVIDERS_OIDC_CLIENT_ID=${OIDC_AUTH_SERVER_CLIENT_ID}
      - NUXT_OIDC_PROVIDERS_OIDC_CLIENT_SECRET=${OIDC_AUTH_SERVER_CLIENT_SECRET}
      - NUXT_OIDC_PROVIDERS_OIDC_AUTHORIZATION_URL=${OIDC_AUTH_SERVER_AUTHORIZATION_URL}
      - NUXT_OIDC_PROVIDERS_OIDC_TOKEN_URL=${OIDC_AUTH_SERVER_TOKEN_URL}
      - NUXT_OIDC_PROVIDERS_OIDC_USER_INFO_URL=${OIDC_AUTH_SERVER_USER_INFO_URL}
      - NUXT_OIDC_PROVIDERS_OIDC_LOGOUT_URL=${OIDC_AUTH_SERVER_LOGOUT_URL}
      - NUXT_OIDC_PROVIDERS_OIDC_OPEN_ID_CONFIGURATION=${OIDC_AUTH_SERVER_WELL_KNOWN}
      
      - NUXT_OIDC_PROVIDERS_OIDC_REDIRECT_URI=${FRONTEND_URL}${OIDC_CALLBACK_PATH}
      - NUXT_OIDC_PROVIDERS_OIDC_LOGOUT_REDIRECT_URI=${FRONTEND_URL}
      
      - NUXT_OIDC_PROVIDERS_OIDC_SCOPE=["openid","profile","email","offline_access","${API_RESOURCE_NAME}"]
      
      - NUXT_OIDC_TOKEN_KEY=${NUXT_OIDC_TOKEN_KEY}
      - NUXT_OIDC_SESSION_SECRET=${NUXT_OIDC_SESSION_SECRET}
      - NUXT_OIDC_AUTH_SESSION_SECRET=${NUXT_OIDC_AUTH_SESSION_SECRET}
    ports:
      - "${FRONTEND_HOST_PORT}:${NUXT_PORT}"
    depends_on:
      - api_server
      - oidc_server

volumes:
  oidc_pgdata:
  api_pgdata:
  rabbitmq_data: