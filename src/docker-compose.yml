version: '3.8'

services:
  oidc_db:
    image: postgres:15-alpine
    container_name: financetracking_identity_db
    environment:
      POSTGRES_USER: ${IDENTITY_DB_USER}
      POSTGRES_PASSWORD: ${IDENTITY_DB_PASSWORD}
      POSTGRES_DB: ${IDENTITY_DB_NAME}
    ports:
      - "${IDENTITY_DB_HOST_PORT}:5432"
    volumes:
      - oidc_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${IDENTITY_DB_USER} -d ${IDENTITY_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  api_db:
    image: postgres:15-alpine
    container_name: financetracking_api_db
    environment:
      POSTGRES_USER: ${API_DB_USER}
      POSTGRES_PASSWORD: ${API_DB_PASSWORD}
      POSTGRES_DB: ${API_DB_NAME}
    ports:
      - "${API_DB_HOST_PORT}:5432"
    volumes:
      - api_pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${API_DB_USER} -d ${API_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5

  oidc_server:
    build: 
      context: .
      dockerfile: ./backend/OidcServer/Dockerfile
    container_name: financetracking_oidc
    environment:
      - ConnectionStrings__DefaultConnection=Host=oidc_db;Port=5432;Database=${IDENTITY_DB_NAME};Username=${IDENTITY_DB_USER};Password=${IDENTITY_DB_PASSWORD}
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:8081
      - ASPNETCORE_Kestrel__Certificates__Default__Password=password
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/identityserver.pfx
      - IdentitySettings__FrontendUrl=${FRONTEND_URL}
      - IdentitySettings__CallbackPath=${OIDC_CALLBACK_PATH}
      - ApiSettings__BaseUrl=http://api_server:8080
      - OidcClients__Nuxt__ClientId=nuxt-client
      - OidcClients__Nuxt__DisplayName=Nuxt Frontend
      - OidcClients__Nuxt__RedirectUri=${FRONTEND_URL}${OIDC_CALLBACK_PATH} 
    ports:
      - "${IDENTITY_SERVER_HOST_PORT}:8081"
    volumes:
      - ./backend/https/identityserver.pfx:/https/identityserver.pfx:ro
    depends_on:
      oidc_db:
        condition: service_healthy

  api_server:
    build: 
      context: .
      dockerfile: ./backend/FinanceTracking.API/Dockerfile
    container_name: financetracking_api
    environment:
      - ConnectionStrings__DefaultConnection=Host=api_db;Port=5432;Database=${API_DB_NAME};Username=${API_DB_USER};Password=${API_DB_PASSWORD}
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Authentication__Authority=https://oidc_server:8081
      - Authentication__ValidIssuer=${IDENTITY_SERVER_URL}
      - Authentication__Audience=my_api_resource
    ports:
      - "${API_SERVER_HOST_PORT}:8080"
    depends_on:
      api_db:
        condition: service_healthy
      oidc_server:
        condition: service_started

volumes:
  oidc_pgdata:
  api_pgdata: